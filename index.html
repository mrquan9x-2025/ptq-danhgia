<!DOCTYPE html>
<html>
  <head>
	<title>O-Assessment</title>
    <base target="_top">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
      body { background-color: #f0f2f5; padding-top: 20px; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; min-height: 100vh; display: flex; flex-direction: column; }
      .container { max-width: 600px; background: white; padding: 30px; border-radius: 15px; box-shadow: 0 4px 20px rgba(0,0,0,0.08); margin-bottom: 20px; }
      .hidden { display: none !important; }
      
      /* Style há»™p tiÃªu chÃ­ */
      .criteria-box { background: #fff; border: 1px solid #e9ecef; border-left: 4px solid #0d6efd; border-radius: 8px; padding: 15px; margin-bottom: 15px; }
      .criteria-box.self { border-left-color: #198754; }
      
      /* Style header nhÃ³m tiÃªu chÃ­ */
      .group-header { 
        background-color: #b1f6fa; padding: 10px 15px; font-weight: bold; text-transform: uppercase; 
        color: #495057; border-radius: 5px; margin-top: 20px; margin-bottom: 15px; border-left: 4px solid #02abb5; font-size: 0.9rem;
      }
      
      .form-header { text-align: center; margin-bottom: 3px; }     /* Giáº£m tá»« 25px xuá»‘ng 5px Ä‘á»ƒ kÃ©o Login Screen lÃªn */
      .slogan { font-size: 0.85rem; color: #6c757d; font-style: italic; margin-bottom: 2px; text-align: center; } /* margin-bottom - SÃ¡t lÃªn trÃªn */
      
      .footer-design { text-align: center; font-size: 0.8rem; color: #adb5bd; margin-top: auto; padding-bottom: 20px; }
      .btn-loading { position: relative; pointer-events: none; opacity: 0.65; }
      .btn-spinner { display: inline-block; width: 1rem; height: 1rem; vertical-align: text-bottom; border: .2em solid currentColor; border-right-color: transparent; border-radius: 50%; animation: spinner-border .75s linear infinite; margin-right: 5px; }
      @keyframes spinner-border { to { transform: rotate(360deg); } }
      .history-stats { font-size: 0.8rem; color: #0dcaf0; margin-top: 8px; padding-top: 5px; border-top: 1px dashed #e9ecef; font-style: italic; }
      
      /* Style cho dÃ²ng chÃº thÃ­ch ngÆ°á»i Ä‘á»c */
      .read-access-note { font-size: 0.75rem; color: #adb5bd; margin-top: 4px; display: block; font-style: italic; }
      .read-access-note::before { content: "ğŸ‘ï¸ "; font-style: normal; }
    
	/* LOGO */
.brand-logo-container {
        text-align: center;        /* CÄƒn giá»¯a logo */
        padding: 5px 0;           /* Khoáº£ng cÃ¡ch trÃªn dÆ°á»›i */
        margin: 0 auto;            /* Äáº£m báº£o cÄƒn giá»¯a */
    }

    .brand-logo-link {
        display: inline-block;     /* GiÃºp link Ã´m sÃ¡t áº£nh */
        text-decoration: none;     /* Bá» gáº¡ch chÃ¢n link */
    }

	.brand-logo {
        height: auto;
        display: block;
        margin: 0 auto;
        
        /* Giá»›i háº¡n tá»‘i Ä‘a 600px trÃªn mÃ n hÃ¬nh lá»›n */
        max-width: 600px;
        
        /* TrÃªn mÃ n hÃ¬nh lá»›n, sáº½ hiá»ƒn thá»‹ tá»‘i Ä‘a 600px (khÃ´ng vÆ°á»£t quÃ¡) */
        width: 100%;                   /* Chiáº¿m full náº¿u nhá» hÆ¡n 600px */
    }

    /* Responsive cho mÃ n hÃ¬nh trung bÃ¬nh vÃ  nhá» */
    @media (max-width: 992px) {
        .brand-logo {
            max-width: 90%;            /* Váº«n giá»¯ % Ä‘á»ƒ co giÃ£n Ä‘áº¹p */
        }
    }

    @media (max-width: 768px) {
        .brand-logo-container {
            padding: 15px 0;
        }
        .brand-logo {
            max-width: 95%;
        }
    }

    @media (max-width: 480px) {
        .brand-logo {
            max-width: 100%;
        }
    }
	
	
	</style>
  </head>
  <body>
    <div class="container">
      <div class="form-header">
	  		<!-- LOGO -->
<div class="brand-logo-container">
    <img src="https://i.postimg.cc/25GYbBYp/OA.jpg" 
    alt="Há»† THá»NG ÄÃNH GIÃ OA" 
    class="brand-logo">
</div>
        <h5 id="appTitle" class="text-primary fw-bold mb-0">Há»— trá»£ tá»± Ä‘Ã¡nh giÃ¡ vÃ  Ä‘Ã¡nh giÃ¡ Ä‘á»“ng Ä‘áº³ng</h5>
        <p id="teacherName" class="text-muted mt-2 small"></p>
      </div>

      <!-- LOGIN SCREEN -->
      <div id="loginScreen">
        <!-- Slogan chá»‰ hiá»‡n á»Ÿ Ä‘Ã¢y -->
        <div id="sloganDisplay" class="slogan"></div>

        <div class="mb-3">
          <label class="form-label fw-bold">MÃ£ Sinh ViÃªn</label>
          <input type="text" class="form-control" id="masv" placeholder="Nháº­p mÃ£ sinh viÃªn">
        </div>
        <div class="mb-3">
          <label class="form-label fw-bold">Máº­t kháº©u</label>
          <input type="password" class="form-control" id="password" placeholder="Nháº­p máº­t kháº©u">
        </div>
        
        <!-- Checkbox Ghi nhá»› -->
        <div class="form-check mb-3">
          <input class="form-check-input" type="checkbox" id="rememberMe">
          <label class="form-check-label small text-secondary" for="rememberMe">
            LÆ°u thÃ´ng tin Ä‘Äƒng nháº­p
          </label>
        </div>

        <button id="btnLogin" onclick="handleLogin()" class="btn btn-primary w-100 py-2 fw-bold shadow-sm mb-2">ÄÄ‚NG NHáº¬P</button>
		
		
<!-- NÃšT Má» HÆ¯á»šNG DáºªN (Äáº·t á»Ÿ mÃ n hÃ¬nh Login) -->
<div class="text-center mt-4">
  <a href="#" onclick="document.getElementById('helpModal').classList.remove('hidden')" class="text-decoration-none small text-secondary d-inline-flex align-items-center">
    <span style="display:inline-block; width:20px; height:20px; border: 1px solid #999; border-radius: 50%; text-align:center; line-height:18px; margin-right:5px; font-weight:bold;">?</span> 
    Giá»›i thiá»‡u & HÆ°á»›ng dáº«n
  </a>
</div>

<!-- MODAL HÆ¯á»šNG DáºªN (Responsive & Scrollable) -->
<div id="helpModal" class="hidden" style="position: fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.6); z-index: 2000; display: flex; align-items: center; justify-content: center;">
  
  <!-- Container: Width 95% cho mobile, Max 500px cho PC -->
  <div class="container shadow rounded bg-white p-0" style="width: 95%; max-width: 500px; max-height: 90vh; display: flex; flex-direction: column; overflow: hidden;">
    
    <!-- Header -->
    <div class="card-header bg-info text-white fw-bold d-flex justify-content-between align-items-center p-3">
      <span>HÆ¯á»šNG DáºªN Sá»¬ Dá»¤NG</span>
      <button onclick="document.getElementById('helpModal').classList.add('hidden')" class="btn btn-sm btn-light rounded-circle fw-bold text-info" style="width:30px; height:30px; padding:0; display:flex; align-items:center; justify-content:center;">âœ•</button>
    </div>

    <!-- Body: CÃ³ thanh cuá»™n (Scrollable) -->
    <div class="card-body p-3" style="overflow-y: auto; flex: 1;">
      
      <!-- Má»¥c 1 -->
      <h6 class="fw-bold text-primary mb-1">1. Má»¥c Ä‘Ã­ch</h6>
      <p class="small text-muted mb-3">Há»‡ thá»‘ng giÃºp sinh viÃªn rÃ¨n luyá»‡n ká»¹ nÄƒng Ä‘Ã¡nh giÃ¡, tÆ° duy pháº£n biá»‡n vÃ  tá»± soi chiáº¿u nÄƒng lá»±c thÃ´ng qua hoáº¡t Ä‘á»™ng ÄÃ¡nh giÃ¡ Ä‘á»“ng Ä‘áº³ng (Peer Review) vÃ  Tá»± Ä‘Ã¡nh giÃ¡ (Self Review).</p>
      
      <!-- Má»¥c 2 -->
      <h6 class="fw-bold text-primary mb-1">2. Quy trÃ¬nh thá»±c hiá»‡n</h6>
      <ul class="small text-muted mb-3 ps-3">
          <li class="mb-1"><strong>ÄÄƒng nháº­p:</strong> DÃ¹ng MÃ£ SV & Máº­t kháº©u Ä‘Æ°á»£c cáº¥p.</li>
          <li class="mb-1"><strong>KhÃ¡n giáº£:</strong> Cháº¥m Ä‘iá»ƒm nhÃ³m báº¡n & GÃ³p Ã½ (ThÃ´ng tin ngÆ°á»i cháº¥m Ä‘Æ°á»£c <u>áº¨n danh</u>).</li>
          <li class="mb-1"><strong>NhÃ³m trÃ¬nh bÃ y:</strong>
              <ul class="ps-3 mt-1">
                  <li>Tá»± cháº¥m Ä‘iá»ƒm sáº£n pháº©m cá»§a nhÃ³m.</li>
                  <li>Cháº¥m Ä‘Ã³ng gÃ³p cá»§a tá»«ng thÃ nh viÃªn trong nhÃ³m.</li>
                  <li><em>LÆ°u Ã½: CÃ³ tÃ­nh Ä‘áº¿n trÆ°á»ng há»£p thÃ nh viÃªn "gÃ¡nh team".</em></li>
              </ul>
          </li>
      </ul>

      <!-- Má»¥c 3 -->
      <h6 class="fw-bold text-primary mb-1">3. Xem bÃ¡o cÃ¡o (Feedback)</h6>
      <p class="small text-muted mb-3">Nháº¥n nÃºt "Xem káº¿t quáº£..." Ä‘á»ƒ xem biá»ƒu Ä‘á»“ so sÃ¡nh Ä‘iá»ƒm Ä‘Æ°á»£c Ä‘Ã¡nh giÃ¡ vá»›i tá»± Ä‘Ã¡nh giÃ¡ vÃ  Ä‘á»c gÃ³p Ã½ tá»« lá»›p.</p>

      <!-- Má»¥c 4 (Má»šI) -->
      <div class="alert alert-light border border-info mb-0">
        <h6 class="fw-bold text-dark mb-2" style="font-size: 0.9rem;">4. Káº¿t quáº£ nÃ y Ä‘Æ°á»£c sá»­ dá»¥ng tháº¿ nÃ o?</h6>
        <p class="small text-muted mb-2 text-justify">
          <strong>ğŸ“ Vá»›i Sinh viÃªn:</strong> Káº¿t quáº£ lÃ  "táº¥m gÆ°Æ¡ng" pháº£n chiáº¿u, há»— trá»£ tá»± cáº£i thiá»‡n. HÃ£y Ä‘á»c ká»¹ biá»ƒu Ä‘á»“ vÃ  gÃ³p Ã½ Ä‘á»ƒ phÃ¡t huy Ä‘iá»ƒm máº¡nh, kháº¯c phá»¥c Ä‘iá»ƒm yáº¿u.
        </p>
        <p class="small text-muted mb-0 text-justify">
          <strong>ğŸ“Š Vá»›i giáº£ng viÃªn:</strong> Giáº£ng viÃªn sáº½ dÃ¹ng dá»¯ liá»‡u Ä‘á»ƒ tÃ­nh Ä‘iá»ƒm cá»§a nhÃ³m vÃ  Ä‘iá»ƒm tá»«ng cÃ¡ nhÃ¢n theo cÃ¡c trá»ng sá»‘ xÃ¡c Ä‘á»‹nh.
        </p>
      </div>

    </div>

    <!-- Footer -->
    <div class="card-footer text-center p-2 bg-light border-top">
      <button onclick="document.getElementById('helpModal').classList.add('hidden')" class="btn btn-secondary btn-sm px-4">ÄÃ£ hiá»ƒu</button>
    </div>
  </div>
</div>
		
		
        <div class="text-end">
          <a href="#" onclick="showChangePass()" class="text-decoration-none small">Äá»•i máº­t kháº©u?</a>
        </div>
        <div id="loginError" class="text-danger mt-3 text-center small"></div>
      </div>

      <!-- CHANGE PASS SCREEN -->
      <div id="changePassScreen" class="hidden">
        <h5 class="text-center text-primary mb-3">Äá»”I Máº¬T KHáº¨U</h5>
        <div class="mb-3"><label class="form-label small fw-bold">MÃ£ Sinh ViÃªn</label><input type="text" class="form-control" id="cp_masv"></div>
        <div class="mb-3"><label class="form-label small fw-bold">Máº­t kháº©u cÅ©</label><input type="password" class="form-control" id="oldPass"></div>
        <div class="mb-3"><label class="form-label small fw-bold">Máº­t kháº©u má»›i</label><input type="password" class="form-control" id="newPass"></div>
        <button id="btnChangePass" onclick="doChangePass()" class="btn btn-success w-100 fw-bold">XÃ¡c nháº­n Ä‘á»•i</button>
        <button onclick="hideChangePass()" class="btn btn-link w-100 mt-2 text-decoration-none">Quay láº¡i</button>
      </div>

      <!-- FORM SCREEN -->
      <div id="formScreen" class="hidden">
        <div class="alert alert-primary shadow-sm">
          <div class="d-flex justify-content-between">
             <div>Xin chÃ o: <strong id="uName"></strong></div>
             <button onclick="location.reload()" class="btn btn-sm btn-light text-primary fw-bold py-0">ThoÃ¡t</button>
          </div>
          <div class="small mt-1">
             MSV: <span id="uMSV" class="fw-bold"></span> - Lá»›p: <span id="uClass"></span> | NhÃ³m: <span id="uGroup"></span>
         
        <!-- NÃºt xem bÃ¡o cÃ¡o (Xanh Ä‘áº­m) -->
        <div class="text-center mb-3">
            <button onclick="showReport()" class="btn btn-success shadow-sm fw-bold" style="background-color: #157347; border-color: #146c43;">
                ğŸ“Š XEM Káº¾T QUáº¢ ÄÃNH GIÃ NHÃ“M MÃŒNH
            </button>
        </div>

		 </div>
        </div>

        <div class="text-center mb-3">
          <span class="badge bg-warning text-dark px-3 py-2 shadow-sm fs-6">
            Äang Ä‘Ã¡nh giÃ¡: NhÃ³m <span id="targetGroupDisplay" class="fw-bold"></span>
          </span>
          <div id="statusBadge" class="mt-2"></div>
        </div>



        <div id="dynamicForm"></div>

        <div id="noSession" class="hidden text-center py-5">
          <h4 class="text-muted">ChÆ°a cÃ³ phiÃªn Ä‘Ã¡nh giÃ¡ nÃ o má»Ÿ.</h4>
          <p class="text-secondary small">Vui lÃ²ng Ä‘á»£i Giáº£ng viÃªn thÃ´ng bÃ¡o.</p>
        </div>
      </div>

      <!-- SUCCESS SCREEN -->
      <div id="successScreen" class="hidden text-center py-5">
        <div class="mb-3 text-success" style="font-size: 60px;">âœ”</div>
        <h3 class="text-success fw-bold">ThÃ nh cÃ´ng!</h3>
        <p class="text-muted">Dá»¯ liá»‡u Ä‘Ã£ Ä‘Æ°á»£c ghi nháº­n.</p>
        <button onclick="location.reload()" class="btn btn-outline-primary mt-3 px-4">Quay láº¡i</button>
      </div>
    </div>

    <!-- POPUP MODAL BÃO CÃO -->
    <div id="reportModal" class="hidden" style="position: fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.6); z-index: 1000; overflow-y: auto; backdrop-filter: blur(2px);">
        <div class="container mt-4 mb-5" style="position: relative;">
            <div class="card shadow-lg border-0">
                <div class="card-header bg-primary text-white">
                    <div class="d-flex justify-content-between align-items-center mb-2">
                        <h5 class="mb-0 fw-bold">Káº¾T QUáº¢ ÄÃNH GIÃ</h5>
                        <button onclick="closeReport()" class="btn btn-sm btn-light text-primary fw-bold rounded-circle" style="width: 30px; height: 30px; padding: 0;">âœ•</button>
                    </div>
                    <div class="input-group input-group-sm">
                        <label class="input-group-text bg-white text-primary fw-bold">Chá»n xem káº¿t quáº£:</label>
                        <select id="reportSessionSelect" class="form-select fw-bold" onchange="changeReportSession()"></select>
                    </div>
                </div>
                <div class="card-body bg-light">
                    <div class="bg-white p-2 rounded shadow-sm mb-3">
                        <h6 class="text-center text-uppercase fw-bold text-secondary small pt-2">Biá»ƒu Ä‘á»“ tiÃªu chÃ­ (Radar Chart)</h6>
                        <div style="height: 350px; position: relative;"><canvas id="reportChart"></canvas></div>
                        <div class="alert alert-light border mt-3 small text-muted" style="font-size: 0.85rem; background-color: #f8f9fa;">
                            <strong class="text-dark">ğŸ’¡ Giáº£i thÃ­ch biá»ƒu Ä‘á»“:</strong>
                            <ul class="mb-0 ps-3 mt-1">
                                <li>VÃ¹ng <span style="color:rgba(255, 99, 132, 1)"><strong>Äá»</strong></span> bao trÃ¹m <span style="color:rgba(54, 162, 235, 1)"><strong>Xanh</strong></span>: NhÃ³m báº¡n Ä‘ang <strong>tá»± tin thÃ¡i quÃ¡</strong>.</li>
                                <li>VÃ¹ng <span style="color:rgba(54, 162, 235, 1)"><strong>Xanh</strong></span> rá»™ng hÆ¡n <span style="color:rgba(255, 99, 132, 1)"><strong>Äá»</strong></span>: NhÃ³m báº¡n <strong>lÃ m tá»‘t hÆ¡n báº¡n nghÄ©</strong>.</li>
                                <li>Hai vÃ¹ng <strong>trÃ¹ng khÃ­t</strong>: CÃ¡c báº¡n <strong>tá»± nháº­n thá»©c ráº¥t tá»‘t</strong>.</li>
                            </ul>
                        </div>
                    </div>
                    <h6 class="text-primary fw-bold mt-4 border-bottom pb-2">ğŸ’¬ GÃ³p Ã½ tá»« cÃ¡c nhÃ³m khÃ¡c (Peer):</h6>
                    <div id="peerCommentList" class="bg-white p-3 rounded shadow-sm mb-3" style="max-height: 200px; overflow-y: auto;"><div class="text-center"><span class="btn-spinner text-primary"></span></div></div>
                    <h6 class="text-success fw-bold mt-3 border-bottom pb-2">ğŸ“ Tá»± nháº­n xÃ©t cá»§a nhÃ³m (Self):</h6>
                    <div id="selfCommentList" class="bg-white p-3 rounded shadow-sm" style="max-height: 150px; overflow-y: auto;"></div>
                </div>
                <div class="card-footer text-center bg-white"><button onclick="closeReport()" class="btn btn-secondary px-4 fw-bold">ÄÃ³ng</button></div>
            </div>
        </div>
    </div>

    <!-- FOOTER DESIGN -->
    <div class="footer-design">Design by Pháº¡m Tháº¿ QuÃ¢n</div>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
  // ===============================================================
  // DÃN URL SCRIPT Cá»¦A Báº N VÃ€O ÄÃ‚Y
  const API_URL = "https://script.google.com/macros/s/AKfycbykuUiEuBtBWAV82C96_W4sNpD0scuyeGFdfskr29WiZA8e0ABPVwEcgN2Eo3cvRSA/exec"; 
  // ===============================================================

  var GLOBAL_CONFIG = {}; 
  var CRITERIA_LIST = [];
  var CURRENT_USER = {};
  var CURRENT_SESSION = "";
  var HISTORY_STATS = {}; 

  const SLOGANS = [
    "CÃ´ng báº±ng lÃ  chÃ¬a khÃ³a Ä‘á»ƒ má»i ná»— lá»±c Ä‘á»u Ä‘Æ°á»£c ghi nháº­n.",
    "HÃ£y lÃ  táº¥m gÆ°Æ¡ng pháº£n chiáº¿u trung thá»±c nháº¥t cho chÃ­nh mÃ¬nh vÃ  Ä‘á»“ng Ä‘á»™i.",
    "CÃ´ng tÃ¢m trong nháº­n xÃ©t, tháº³ng tháº¯n Ä‘á»ƒ vÆ°Æ¡n xa."
  ];
  
  // INIT
  window.onload = function() {
    // 1. Random Slogan
    var rd = Math.floor(Math.random() * SLOGANS.length);
    document.getElementById('sloganDisplay').innerText = '"' + SLOGANS[rd] + '"';
    
    // 2. Load Remembered User
    var savedUser = localStorage.getItem("tta_user");
    var savedPass = localStorage.getItem("tta_pass");
    if(savedUser && savedPass) {
        document.getElementById('masv').value = savedUser;
        document.getElementById('password').value = savedPass;
        document.getElementById('rememberMe').checked = true;
    }
  };

  // HELPER
  function setBtnLoading(btnId, isLoading) {
    const btn = document.getElementById(btnId);
    if (!btn) return;
    if (isLoading) {
      if (!btn.getAttribute('data-text')) btn.setAttribute('data-text', btn.innerText);
      btn.innerHTML = '<span class="btn-spinner"></span> Äang xá»­ lÃ½...';
      btn.classList.add('btn-loading', 'btn-secondary');
      btn.classList.remove('btn-primary', 'btn-success');
    } else {
      btn.innerHTML = btn.getAttribute('data-text');
      btn.classList.remove('btn-loading', 'btn-secondary');
      if(btnId.includes('Self')) btn.classList.add('btn-success');
      else btn.classList.add('btn-primary');
    }
  }

  // --- LOGIN ---
  function showChangePass() { var loginMSV = document.getElementById('masv').value; if(loginMSV) document.getElementById('cp_masv').value = loginMSV; document.getElementById('loginScreen').classList.add('hidden'); document.getElementById('changePassScreen').classList.remove('hidden'); }
  function hideChangePass() { document.getElementById('changePassScreen').classList.add('hidden'); document.getElementById('loginScreen').classList.remove('hidden'); }
  
  function handleLogin() {
    var masv = document.getElementById('masv').value;
    var pass = document.getElementById('password').value;
    var remember = document.getElementById('rememberMe').checked;

    if(!masv || !pass) { alert("Thiáº¿u thÃ´ng tin!"); return; }
    
    // Xá»­ lÃ½ Ghi nhá»›
    if(remember) {
        localStorage.setItem("tta_user", masv);
        localStorage.setItem("tta_pass", pass);
    } else {
        localStorage.removeItem("tta_user");
        localStorage.removeItem("tta_pass");
    }

    setBtnLoading('btnLogin', true);
    fetch(API_URL + "?action=login&masv=" + masv + "&pass=" + pass)
      .then(res => res.json())
      .then(res => { setBtnLoading('btnLogin', false); if(res.error) document.getElementById('loginError').innerText = res.error; else onLoginSuccess(res); })
      .catch(err => { setBtnLoading('btnLogin', false); alert("Lá»—i káº¿t ná»‘i!"); });
  }

  function doChangePass() {
    var masv = document.getElementById('cp_masv').value;
    var oldPass = document.getElementById('oldPass').value;
    var newPass = document.getElementById('newPass').value;
    if(!masv || !oldPass || !newPass) { alert("Nháº­p Ä‘á»§ thÃ´ng tin!"); return; }
    setBtnLoading('btnChangePass', true);
    fetch(API_URL, { method: 'POST', body: JSON.stringify({ type: 'change_pass', masv: masv, oldPass: oldPass, newPass: newPass }) })
      .then(res => res.json()).then(res => { setBtnLoading('btnChangePass', false); if(res.status == 'success') { alert("Äá»•i máº­t kháº©u thÃ nh cÃ´ng!"); hideChangePass(); } else alert(res.message); })
      .catch(err => { setBtnLoading('btnChangePass', false); alert("Lá»—i káº¿t ná»‘i!"); });
  }

  function onLoginSuccess(res) {
    GLOBAL_CONFIG = res.config;
    CRITERIA_LIST = res.criteria;
    CURRENT_USER = res.student;
    HISTORY_STATS = res.historyStats || {};
    
    document.getElementById('appTitle').innerText = GLOBAL_CONFIG.MON_HOC || "Há»† THá»NG ÄÃNH GIÃ";
    document.getElementById('teacherName').innerText = "Giáº£ng viÃªn: " + (GLOBAL_CONFIG.GIAO_VIEN || "---");
    
    document.getElementById('uName').innerText = CURRENT_USER.hoten;
    document.getElementById('uMSV').innerText = CURRENT_USER.masv; 
    document.getElementById('uClass').innerText = CURRENT_USER.lop; 
    document.getElementById('uGroup').innerText = CURRENT_USER.nhom;
    
    var currentGroup = GLOBAL_CONFIG.NHOM_DANG_DAY;
    CURRENT_SESSION = GLOBAL_CONFIG.BUOI_DANG_DAY;

    document.getElementById('loginScreen').classList.add('hidden');
    document.getElementById('formScreen').classList.remove('hidden');

    if(!currentGroup) { document.getElementById('noSession').classList.remove('hidden'); return; }
    document.getElementById('targetGroupDisplay').innerText = currentGroup + " (Buá»•i " + CURRENT_SESSION + ")";

    var statusDiv = document.getElementById('statusBadge');
    statusDiv.innerHTML = res.hasReviewed ? '<span class="badge bg-success">âœ” ÄÃ£ Ä‘Ã¡nh giÃ¡ xong</span>' : '<span class="badge bg-secondary">âšª ChÆ°a Ä‘Ã¡nh giÃ¡</span>';

    if(String(CURRENT_USER.nhom) == String(currentGroup)) renderSelfForm(res.groupMembers, res.hasReviewed);
    else renderPeerForm(res.hasReviewed);
  }

  // --- RENDER FORMS (CÃ“ CHÃš THÃCH NGÆ¯á»œI Äá»ŒC) ---
  
  function renderPeerForm(isDisabled) {
    var html = `<h5 class="mb-3 text-primary border-bottom pb-2">ÄÃ¡nh giÃ¡ nhÃ³m báº¡n</h5>`;
    var lastGroup = "";
    CRITERIA_LIST.forEach((c, idx) => {
      if(c.group && c.group != lastGroup) { html += `<div class="group-header">${c.group}</div>`; lastGroup = c.group; }
      var key = 'tc' + (idx+1); var historyText = "";
      if(HISTORY_STATS[key]) historyText = `<div class="history-stats">Trung bÃ¬nh cÃ¡c nhÃ³m trÆ°á»›c báº¡n cháº¥m: <strong>${HISTORY_STATS[key]}</strong></div>`;
      html += `<div class="criteria-box"><label class="fw-bold text-dark">${idx+1}. ${c.title}</label><div class="text-muted small fst-italic mb-2 border-bottom pb-1">${c.desc}</div><div class="d-flex align-items-center justify-content-between"><span class="small fw-bold text-primary">Thang Ä‘iá»ƒm: ${c.max}</span><input type="number" id="tc_${idx+1}" class="form-control border-primary fw-bold text-center" style="width: 100px;" step="0.5" min="0" max="${c.max}" placeholder="0-${c.max}" ${isDisabled ? 'disabled' : ''}></div>${historyText}</div>`;
    });

    // CHÃš THÃCH NGÆ¯á»œI Äá»ŒC
    html += `<div class="mb-3 mt-4">
        <label class="form-label fw-bold">Nháº­n xÃ©t / GÃ³p Ã½:</label>
        <textarea class="form-control" id="comment" rows="2" ${isDisabled ? 'disabled' : ''}></textarea>
        <span class="read-access-note">Giáº£ng viÃªn vÃ  thÃ nh viÃªn nhÃ³m Ä‘Æ°á»£c nháº­n xÃ©t sáº½ Ä‘á»c Ä‘Æ°á»£c. Nháº­n xÃ©t sáº½ Ä‘Æ°á»£c áº©n danh.</span>
    </div>
    <button id="btnSubmitPeer" onclick="submitForm('peer')" class="btn btn-primary w-100 py-3 fw-bold shadow-sm" ${isDisabled ? 'disabled' : ''}>
        ${isDisabled ? 'ÄÃƒ Gá»¬I ÄÃNH GIÃ' : 'Gá»¬I ÄÃNH GIÃ'}
    </button>`;
    
    document.getElementById('dynamicForm').innerHTML = html;
  }

function renderSelfForm(members, isDisabled) {
    var html = `<h5 class="mb-3 text-success border-bottom pb-2">Tá»± Ä‘Ã¡nh giÃ¡ nhÃ³m mÃ¬nh</h5>`;
    var lastGroup = "";
    
    CRITERIA_LIST.forEach((c, idx) => {
      // 1. PhÃ¢n nhÃ³m tiÃªu chÃ­
      if(c.group && c.group != lastGroup) { 
         html += `<div class="group-header" style="border-left-color: #198754;">${c.group}</div>`; 
         lastGroup = c.group; 
      }
      
      // 2. HIá»‚N THá»Š Lá»ŠCH Sá»¬ (Má»šI THÃŠM)
      var key = 'tc' + (idx+1);
      var historyText = "";
      if(HISTORY_STATS[key]) {
         historyText = `<div class="history-stats">Trung bÃ¬nh cÃ¡c nhÃ³m trÆ°á»›c báº¡n cháº¥m: <strong>${HISTORY_STATS[key]}</strong></div>`;
      }

      html += `
        <div class="criteria-box self">
          <label class="fw-bold text-dark">${idx+1}. ${c.title}</label>
          <div class="text-muted small fst-italic mb-2 border-bottom pb-1">${c.desc}</div>
          <div class="d-flex align-items-center justify-content-between">
            <span class="small fw-bold text-success">Tá»± cháº¥m (Max ${c.max}):</span>
            <input type="number" id="tc_${idx+1}" class="form-control border-success fw-bold text-center" 
                   style="width: 100px;" step="0.5" min="0" max="${c.max}" placeholder="0-${c.max}" ${isDisabled ? 'disabled' : ''}>
          </div>
          ${historyText} <!-- ChÃ¨n dÃ²ng lá»‹ch sá»­ vÃ o Ä‘Ã¢y -->
        </div>`;
    });

    // CHÃš THÃCH NGÆ¯á»œI Äá»ŒC
    html += `<div class="mb-3 mt-4">
        <label class="form-label fw-bold">Äiá»u tÃ¢m Ä‘áº¯c / Cáº§n cáº£i thiá»‡n:</label>
        <textarea class="form-control" id="comment" rows="2" ${isDisabled ? 'disabled' : ''}></textarea>
        <span class="read-access-note">Giáº£ng viÃªn vÃ  thÃ nh viÃªn nhÃ³m báº¡n sáº½ Ä‘á»c Ä‘Æ°á»£c. Nháº­n xÃ©t sáº½ Ä‘Æ°á»£c áº©n danh.</span>
    </div>`;
    
    var maxPoint = GLOBAL_CONFIG.DIEM_DONG_GOP_MAX || 10;
    var maxBonus = GLOBAL_CONFIG.SO_NGUOI_BONUS || 0;

    html += `<div class="mt-4 pt-3 border-top">
        <div class="alert alert-warning small mb-3">
            <strong><center>ÄÃNH GIÃ THÃ€NH VIÃŠN NHÃ“M</center></strong>
			<strong>LÆ°u Ã½:</strong><br>
            - Äiá»ƒm chuáº©n: <strong>10</strong> (khi Ä‘Ã³, Ä‘iá»ƒm thÃ nh viÃªn báº±ng Ä‘iá»ƒm cá»§a nhÃ³m).<br>
            - Tá»‘i Ä‘a: <strong>${maxPoint}</strong> Ä‘iá»ƒm. Vá»›i thÃ nh viÃªn gÃ¡nh Team.<br>
            - Tá»‘i Ä‘a <strong>${maxBonus}</strong> ngÆ°á»i Ä‘Æ°á»£c Ä‘iá»ƒm trÃªn 10.<br>
			- NÃªn viáº¿t nháº­n xÃ©t vá»›i thÃ nh viÃªn cÃ³ Ä‘iá»ƒm khÃ¡c 10.
        </div>
    `;

    members.forEach(m => {
      var isMe = (String(m.masv) == String(CURRENT_USER.masv));
      var val = isMe ? 10 : "";
      html += `
        <div class="row mb-2 align-items-center p-2 border rounded bg-white mx-0 shadow-sm">
          <div class="col-8 ps-1">
            <span class="fw-bold">${m.hoten}</span><br><small class="text-muted">${m.masv}</small>
          </div>
          <div class="col-4 pe-1">
            <input type="number" class="form-control member-contrib text-center fw-bold border-warning" 
                   data-masv="${m.masv}" value="${val}" placeholder="0-${maxPoint}" ${isDisabled ? 'disabled' : ''}>
          </div>
        </div>
      `;
    });

    // CHÃš THÃCH NGÆ¯á»œI Äá»ŒC
    html += `<div class="mt-2">
        <textarea class="form-control" id="memberComment" rows="2" placeholder="Nháº­n xÃ©t chi tiáº¿t vá» thÃ nh viÃªn..." ${isDisabled ? 'disabled' : ''}></textarea>
        <span class="read-access-note">Chá»‰ giáº£ng viÃªn Ä‘á»c Ä‘Æ°á»£c.</span>
    </div>
    <button id="btnSubmitSelf" onclick="submitForm('self')" class="btn btn-success w-100 mt-3 py-3 fw-bold shadow-sm" ${isDisabled ? 'disabled' : ''}>
        ${isDisabled ? 'ÄÃƒ Gá»¬I Tá»° ÄÃNH GIÃ' : 'Gá»¬I Tá»° ÄÃNH GIÃ'}
    </button></div>`;

    document.getElementById('dynamicForm').innerHTML = html;
  }

  // --- SUBMIT (Giá»¯ nguyÃªn) ---
  function submitForm(type) {
    var btnId = (type == 'peer') ? 'btnSubmitPeer' : 'btnSubmitSelf';
    var scores = {};
    for(var i=0; i<CRITERIA_LIST.length; i++) {
        var el = document.getElementById('tc_' + (i+1));
        if(!el.value) { alert("Vui lÃ²ng nháº­p Ä‘á»§ Ä‘iá»ƒm cÃ¡c tiÃªu chÃ­!"); el.focus(); return; }
        if(Number(el.value) > CRITERIA_LIST[i].max) { alert("Äiá»ƒm tiÃªu chÃ­ "+(i+1)+" vÆ°á»£t quÃ¡ giá»›i háº¡n!"); el.focus(); return; }
        scores['tc'+(i+1)] = el.value;
    }
    var data = { type: type, reviewerId: CURRENT_USER.masv, session: CURRENT_SESSION, scores: scores, comment: document.getElementById('comment').value };
    if(type == 'peer') {
        data.targetGroup = document.getElementById('targetGroupDisplay').innerText.split(" ")[0];
    } else {
        data.myGroup = CURRENT_USER.nhom;
        var contribs = []; var bonusCount = 0; var maxPoint = GLOBAL_CONFIG.DIEM_DONG_GOP_MAX || 10; var limitBonus = GLOBAL_CONFIG.SO_NGUOI_BONUS || 0; var inputs = document.querySelectorAll('.member-contrib'); var hasError = false;
        inputs.forEach(inp => { var val = Number(inp.value); if(inp.value === "" || val < 0 || val > maxPoint) hasError = true; if(val > 10) bonusCount++; contribs.push({ masv: inp.getAttribute('data-masv'), point: val }); });
        if(hasError) { alert("Äiá»ƒm thÃ nh viÃªn khÃ´ng há»£p lá»‡ (0 - "+maxPoint+")"); return; }
        if(bonusCount > limitBonus) { alert("Vi pháº¡m quy Ä‘á»‹nh: Chá»‰ tá»‘i Ä‘a "+limitBonus+" ngÆ°á»i Ä‘Æ°á»£c trÃªn 10 Ä‘iá»ƒm!"); return; }
        data.contributions = contribs; data.memberComment = document.getElementById('memberComment').value;
    }
    setBtnLoading(btnId, true);
    fetch(API_URL, { method: 'POST', body: JSON.stringify(data) }).then(res => res.json()).then(res => { setBtnLoading(btnId, false); if(res.status == 'success') { document.getElementById('formScreen').classList.add('hidden'); document.getElementById('successScreen').classList.remove('hidden'); } else { alert("Lá»—i: " + res.message); } }).catch(err => { setBtnLoading(btnId, false); alert("Lá»—i gá»­i dá»¯ liá»‡u!"); });
  }

  // --- REPORT LOGIC (ÄÃ£ sá»­a bá» chá»¯ áº¨n danh) ---
  var myChart = null;
  function showReport() {
    document.getElementById('reportModal').classList.remove('hidden');
    var maxSession = Number(GLOBAL_CONFIG.SO_BUOI) || 2;
    var select = document.getElementById('reportSessionSelect'); select.innerHTML = "";
    for(var i=1; i<=maxSession; i++) { var opt = document.createElement('option'); opt.value = i; opt.text = "Buá»•i " + i; if(i == CURRENT_SESSION) opt.selected = true; select.appendChild(opt); }
    fetchReportData(select.value);
  }
  function changeReportSession() { fetchReportData(document.getElementById('reportSessionSelect').value); }
  function fetchReportData(sessionVal) {
    document.getElementById('peerCommentList').innerHTML = '<div class="text-center py-3 text-muted">â³ Äang táº£i...</div>';
    document.getElementById('selfCommentList').innerHTML = '<div class="text-center py-3 text-muted">â³ Äang táº£i...</div>';
    fetch(API_URL, { method: 'POST', body: JSON.stringify({ type: 'get_report', groupId: CURRENT_USER.nhom, session: sessionVal }) }).then(res => res.json()).then(res => { if(res.status == 'success') { renderChart(res.peerMap, res.selfMap); renderCommentsList(res.peerComments, res.selfComments); } else alert("Lá»—i táº£i dá»¯ liá»‡u!"); }).catch(err => console.error(err));
  }
  function closeReport() { document.getElementById('reportModal').classList.add('hidden'); }
  function renderCommentsList(pComments, sComments) {
    var pHtml = ""; if(!pComments || pComments.length === 0) pHtml = '<p class="text-muted small text-center fst-italic">ChÆ°a cÃ³ gÃ³p Ã½ nÃ o.</p>'; else pComments.forEach(c => { if(c.trim() !== "") pHtml += `<div class="mb-2 pb-2 border-bottom small text-dark">ğŸ”¹ ${c}</div>`; });
    document.getElementById('peerCommentList').innerHTML = pHtml;
    // ÄÃ£ bá» chá»¯ (áº¨n danh)
    var sHtml = ""; if(!sComments || sComments.length === 0) sHtml = '<p class="text-muted small text-center fst-italic">NhÃ³m chÆ°a tá»± nháº­n xÃ©t.</p>'; else sComments.forEach(c => { if(c.trim() !== "") sHtml += `<div class="mb-2 pb-2 border-bottom small text-success">ğŸ”¸ ${c}</div>`; });
    document.getElementById('selfCommentList').innerHTML = sHtml;
  }
  function renderChart(peerMap, selfMap) {
    var ctx = document.getElementById('reportChart').getContext('2d');
    var labels = []; var peerData = []; var selfData = [];
    CRITERIA_LIST.forEach((c, idx) => { var shortTitle = (idx+1) + ". " + c.title.split(' ').slice(0, 3).join(' ') + '..'; labels.push(shortTitle); var key = 'tc' + (idx+1); peerData.push(peerMap[key] || 0); selfData.push(selfMap[key] || 0); });
    if(myChart) myChart.destroy();
    myChart = new Chart(ctx, { type: 'radar', data: { labels: labels, datasets: [{ label: 'ÄÆ°á»£c Ä‘Ã¡nh giÃ¡ (Peer)', data: peerData, backgroundColor: 'rgba(54, 162, 235, 0.2)', borderColor: 'rgba(54, 162, 235, 1)', borderWidth: 2, pointRadius: 0 }, { label: 'Tá»± Ä‘Ã¡nh giÃ¡ (Self)', data: selfData, backgroundColor: 'rgba(255, 99, 132, 0.2)', borderColor: 'rgba(255, 99, 132, 1)', borderWidth: 2, pointRadius: 0 }] }, options: { plugins: { legend: { position: 'bottom' }, tooltip: { enabled: false }, datalabels: { display: false } }, scales: { r: { angleLines: { display: true }, suggestedMin: 0, suggestedMax: 10, ticks: { display: false, stepSize: 2 }, pointLabels: { font: { size: 11, weight: 'bold' } } } }, maintainAspectRatio: false } });
  }
</script>
  </body>
</html>
